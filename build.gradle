rootProject.version = '9.9.1-alpha3'
group = 'com.spaceshift'

subprojects {

    repositories {
        mavenCentral()
    }

    apply plugin: "java-library"
    apply plugin: 'maven-publish'

    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11

    ext {
        projectreactorVersion = '3.2.9.RELEASE'
        sl4jVersion = '1.7.26'
        javaxMailVersion = "1.5.0-b01"
        testcontainersVersion = '1.11.1'
        lombokVersion = '1.18.6'
        junitJupiterVersion = "5.4.2"
        jetbrainsAnnotation = '17.0.0'
        bintrayVersion = version
    }

    javadoc {
        failOnError = false
    }

    test {
        useJUnitPlatform()
    }

    dependencies {
        compileOnly "org.jetbrains:annotations:$jetbrainsAnnotation"
        compileOnly "org.projectlombok:lombok:$lombokVersion"
        annotationProcessor "org.projectlombok:lombok:$lombokVersion"
    
        testImplementation "org.junit.jupiter:junit-jupiter-api:$junitJupiterVersion"
        testCompileOnly "org.projectlombok:lombok:$lombokVersion"
        testCompileOnly "org.jetbrains:annotations:$jetbrainsAnnotation"
        testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:$junitJupiterVersion"
        testAnnotationProcessor "org.projectlombok:lombok:$lombokVersion"
    }

    /*compileJava {
        inputs.property("moduleName", jar.baseName)
        doFirst {
            options.compilerArgs = [
                '--module-path', classpath.asPath,
            ]
            classpath = files()
        }
    }*/

    compileJava {
        options.encoding = "UTF-8"
    }

    task sourcesJar(type: Jar, dependsOn: classes) {
        afterEvaluate {
            getArchiveClassifier().set("sources")
            getArchiveBaseName().set(jar.getArchiveBaseName())
            from sourceSets.main.allSource
        }
    }

    task javadocJar(type: Jar, dependsOn: javadoc) {
        afterEvaluate {
            getArchiveClassifier().set("javadoc")
            getArchiveBaseName().set(jar.getArchiveBaseName())
            from sourceSets.main.allSource
        }
    }

    publishing {
        repositories {
            maven {
                name = "GitHubPackages"
                url = uri("https://maven.pkg.github.com/javasabr/maven-repo")
                credentials {
                    username = project.findProperty("gpr.user") ?: System.getenv("GITHUB_USERNAME")
                    password = project.findProperty("gpr.key") ?: System.getenv("GITHUB_TOKEN")
                }
            }
        }

        publications {
            mavenJava(MavenPublication) {
                from components.java
                artifact sourcesJar
                artifact javadocJar
                version = rootProject.version
                afterEvaluate {
                    artifactId = jar.baseName
                    groupId = rootProject.group
                }
            }
        }
    }

    configurations {
        testArtifacts.extendsFrom testRuntime
    }

    task testJar(type: Jar) {
        getArchiveClassifier().set("test")
        from sourceSets.test.output
    }

    artifacts {
        testArtifacts testJar
    }

    tasks.withType(Test) {
        maxParallelForks = Runtime.runtime.availableProcessors()
    }
}

wrapper {
    gradleVersion = '7.4.2'
    distributionType = Wrapper.DistributionType.ALL
}
